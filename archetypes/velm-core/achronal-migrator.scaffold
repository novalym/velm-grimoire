# =================================================================================
# == GNOSTIC ARCHETYPE: ACHRONAL MIGRATOR (V-Î©-TOTALITY-SCHEMA-EVOLUTION)        ==
# =================================================================================
# @description: Forges a self-migrating project core. Detects drift between the 
#               engine's internal schema (V25 -> V26) and the project's 
#               'scaffold.lock', performing automatic alchemical transmutation.
# =================================================================================

# --- I. THE ALTAR OF GNOSTIC WILL ---
$$ current_engine_version = "25.0.0"
$$ package_name = {{ package_name | default(project_slug | snake) }}

# --- II. THE MIGRATION ORACLE (The Transmutation Script) ---
scripts/meta/
    # [ASCENSION 1]: Block-End Resonance
    # We use unescaped triple-quotes for the boundary. The engine's Backslash 
    # Healing will handle internal quotes if they existed.
    migrate_chronicle.py :: """
    #!/usr/bin/env python3
    import json
    import os
    from pathlib import Path
    from datetime import datetime

    ENGINE_VERSION = "{{ current_engine_version }}"

    def evolve_chronicle():
        print(f"ðŸŒ€ [MIGRATOR] Gauging temporal drift (Engine: {ENGINE_VERSION})...")
        root = Path(os.getcwd())
        lock_path = root / "scaffold.lock"
        
        if not lock_path.exists():
            print("âœ… No chronicle found. Starting from Gnostic Zero.")
            return

        # 1. READ THE PAST
        try:
            lock_data = json.loads(lock_path.read_text(encoding='utf-8'))
            lock_version = lock_data.get("chronicle_version", "0.0.0")
        except Exception as e:
            print(f"âŒ ERROR: Chronicle is profane (malformed): {e}")
            return

        if lock_version == ENGINE_VERSION:
            print("âœ… Chronicle is in perfect alignment with the Engine.")
            return

        # 2. PERFORM THE TRANSMUTATION
        print(f"âš¡ DRIFT DETECTED: {lock_version} -> {ENGINE_VERSION}")
        
        # [ASCENSION 5]: The Backup Rite
        backup_path = root / ".scaffold" / "backups" / f"scaffold.lock.pre-{lock_version}.bak"
        backup_path.parent.mkdir(parents=True, exist_ok=True)
        import shutil
        shutil.copy2(lock_path, backup_path)
        print(f"ðŸ“œ [MIGRATOR] Past reality enshrined in {backup_path.name}")

        # 3. ALCHEMICAL PATCHING (V25 -> V26 logic)
        if lock_version.startswith("25"):
             lock_data["chronicle_version"] = ENGINE_VERSION
             if "integrity" not in lock_data:
                 lock_data["integrity"] = {"merkle_root": "0xVOID"}
        
        # 4. INSCRIBE THE NEW FUTURE
        lock_path.write_text(json.dumps(lock_data, indent=2), encoding='utf-8')
        print(f"âœ¨ [MIGRATOR] Chronicle has ascended to {ENGINE_VERSION}.")

    if __name__ == "__main__":
        evolve_chronicle()
    """

# --- III. THE KINETIC SYMPHONY ---
# [ASCENSION 2]: Sigil Sovereignty
# We explicitly add the '::' sigil to the Makefile to ensure its soul is 
# recognized as content, not a directory.
Makefile :: """
.PHONY: evolve-core

evolve-core: ## Transmute the project chronicle to match the latest engine
    @poetry run python scripts/meta/migrate_chronicle.py
"""

# --- IV. THE MAESTRO'S WILL ---
# [ASCENSION 3]: Absolute Indentation Anchoring
# This block is now outside the Python file's scope because the block closed correctly.
%% post-run
    proclaim: "Achronal Migrator manifest in 'scripts/meta/'."
    proclaim: "Target Engine Version: [magenta]{{ current_engine_version }}[/magenta]"
    
    # Automatically check for drift on every inception
    python scripts/meta/migrate_chronicle.py
    
    proclaim: "[bold green]âœ… Evolution Logic Ready.[/bold green]"
    proclaim: "To sync your chronicle after an engine update: [bold cyan]make evolve-core[/bold cyan]"

%% on-heresy
    proclaim: "[bold red]Migration logic failed.[/bold red]"
    rm -rf scripts/meta/migrate_chronicle.py