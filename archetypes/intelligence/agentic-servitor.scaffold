# =================================================================================
# == GNOSTIC ARCHETYPE: AGENTIC SERVITOR (V-Ω-TOTALITY-V6-ROOT-STABLE)          ==
# =================================================================================
# @description: A transcendental autonomous worker. Executes multi-step AI plans
#               using a ReAct reasoning loop with tool-use and human-authorization.
# @category: Intelligence
# @tags: agent, worker, autonomous, openai, pydantic, tools
# @difficulty: Grand Architect
# @is_integration: true
# @dna: project_type=python, worker_concurrency=2
# =================================================================================

# --- I. THE ALTAR OF GNOSTIC SOVEREIGNTY ---
$$ is_python = true
$$ project_type = "python"
$$ project_slug = {{ project_name | slug | default("servitor-reality") }}
$$ package_name = {{ project_slug | snake }}

# --- II. THE SCRIPTURE OF FORM (THE BODY) ---
# [ASCENSION: ROOT ANCHOR] 
# We wrap the structure in the project_slug to ensure velm init works 
# correctly in both empty and existing directories.
./

    pyproject.toml :: """
    [tool.poetry]
    name = "{{ project_slug }}"
    version = "0.1.0"
    description = "Autonomous Agentic Servitor forged by VELM."
    authors = ["{{ author | default('The Architect') }}"]
    package-mode = false

    [tool.poetry.dependencies]
    python = "^3.11"
    openai = "^1.12.0"
    structlog = "^24.1.0"

    [build-system]
    requires = ["poetry-core"]
    build-backend = "poetry.core.masonry.api"
    """

    src/{{ package_name }}/
        agents/
            tools.py :: """
            from typing import Annotated, Callable, Dict, List
            from pydantic import BaseModel, Field
            import json
            
            REGISTRY: Dict[str, Callable] = {}
            SCHEMAS: List[dict] = []

            def tool(func):
                \"\"\"Consecrates a function as a Gnostic Tool.\"\"\"
                schema = {
                    "type": "function",
                    "function": {
                        "name": func.__name__,
                        "description": func.__doc__ or "No description",
                        "parameters": {"type": "object", "properties": {}, "required": []}
                    }
                }
                REGISTRY[func.__name__] = func
                SCHEMAS.append(schema)
                return func

            @tool
            def search_knowledge_base(query: str):
                \"\"\"Searches the project's internal Vector Cortex.\"\"\"
                return f"Librarian: Recall sequence initiated for {query}..."
            """

            engine.py :: """
            import logging
            from openai import OpenAI
            from .tools import REGISTRY, SCHEMAS

            client = OpenAI()

            class AgenticMind:
                def __init__(self, system_prompt: str):
                    self.history = [{"role": "system", "content": system_prompt}]

                async def solve(self, goal: str, max_turns: int = 10):
                    # ... reasoning logic ...
                    return "Task Resolved."
            """

    .velm_agent_version :: "1.0.0-Ω"

# --- III. THE MAESTRO'S WILL (THE ACTION) ---
%% post-run
    # [THE CURE]: We can use >> now because the engine strips it!
    proclaim: "The [bold magenta]Agentic Servitor[/bold magenta] has materialized."
    >> poetry install
    proclaim: "[bold green]✔ Inception Complete.[/bold green]"
    proclaim: "Begin the Great Work in [bold cyan]src/{{ package_name }}/agents/engine.py[/bold cyan]."

%% on-heresy
    # [THE CURE]: This only runs if the '>>' commands above fail.
    proclaim: "[bold red]Materialization Fractured.[/bold red]"
    rm -rf pyproject.toml src/{{ package_name }}/agents