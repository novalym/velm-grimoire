# =================================================================================
# == GNOSTIC ARCHETYPE: MIRROR TEST ORACLE (V-Î©-TOTALITY-PROPERTY-FUZZER)        ==
# =================================================================================
# @description: Awakens the Inquisitor's Eye to perform an AST-driven Inquest of your codebase. Forges a parallel "Shadow Twin" test suite using Property-Based Testing to identify unhandled edge cases through high-velocity entropy bombardment.
# @category: Meta
# @tags: testing, fuzzing, hypothesis, property-based, quality, ast, forensics, python
# @difficulty: Grand Architect
# @is_integration: true
# @dna: test_permutations=1000, target_dir=src, auto_generate=true
# =================================================================================

# --- I. THE ALTAR OF GNOSTIC WILL ---
$$ test_permutations = 1000
$$ target_dir = "src"
$$ project_slug = {{ project_slug | default('nebula-reality') }}
$$ package_name = {{ package_name | default(project_slug | snake) }}

# --- II. THE INQUISITOR'S EYE (Forensic Scrier) ---
scripts/intelligence/
    # [ASCENSION 1]: The Mirror Scrier
    # This divine artisan reads your code's soul (AST) and forges the Shadow Twins.
    mirror_scrier.py :: """
    #!/usr/bin/env python3
    import ast
    import os
    import sys
    from pathlib import Path
    from typing import List, Dict, Any

    # =============================================================================
    # == THE MIRROR SCRIER (V-Î©-AST-INQUISITOR)                                  ==
    # =============================================================================
    
    def scry_functions(tree: ast.AST) -> List[Dict[str, Any]]:
        \"\"\"Extracts public function signatures from the AST.\"\"\"
        functions = []
        for node in ast.walk(tree):
            if isinstance(node, ast.FunctionDef):
                # We ignore private souls (those starting with _)
                if node.name.startswith('_'): continue
                
                # Capture arguments
                args = [arg.arg for arg in node.args.args if arg.arg != 'self']
                functions.append({
                    "name": node.name,
                    "args": args,
                    "is_async": isinstance(node, ast.AsyncFunctionDef)
                })
        return functions

    def forge_shadow_twin(source_path: Path, functions: List[Dict[str, Any]], root: Path):
        \"\"\"Materializes a property-based test file in the shadow realm.\"\"\"
        rel_path = source_path.relative_to(root)
        test_path = root / "tests" / "shadow_twins" / f"test_{source_path.name}"
        test_path.parent.mkdir(parents=True, exist_ok=True)
        
        # Calculate the Gnostic Module Path for imports
        module_path = str(rel_path.with_suffix('')).replace(os.sep, '.')
        
        lines = [
            "# == SHADOW TWIN GENERATED BY MIRROR ORACLE ==",
            "# LIF: INFINITY | DO NOT EDIT MANUALLY",
            "import pytest",
            "from hypothesis import given, strategies as st, settings, HealthCheck",
            f"from {module_path} import *",
            "",
            "# Global Adjudication Settings",
            f"settings.register_profile('mirror', max_examples={os.getenv('TEST_PERMUTATIONS', '100')}, ",
            "                          suppress_health_check=[HealthCheck.too_slow])",
            "settings.load_profile('mirror')",
            ""
        ]
        
        for func in functions:
            arg_list = ", ".join(func['args'])
            # We use a universal entropy strategy: text, integers, booleans, or lists of the same
            strategies = ", ".join([f"st.one_of(st.text(), st.integers(), st.booleans(), st.none(), st.lists(st.text()))" for _ in func['args']])
            
            lines.append(f"@given({strategies})")
            if func['is_async']:
                lines.append("@pytest.mark.asyncio")
                lines.append(f"async def test_mirror_{func['name']}({arg_list}):")
                lines.append(f"    # Bombarding async {func['name']} with property entropy")
                lines.append(f"    await {func['name']}({arg_list})")
            else:
                lines.append(f"def test_mirror_{func['name']}({arg_list}):")
                lines.append(f"    # Bombarding {func['name']} with property entropy")
                lines.append(f"    {func['name']}({arg_list})")
            lines.append("")

        test_path.write_text('\\n'.join(lines), encoding='utf-8')
        print(f"âœ¨ [ORACLE] Shadow Twin manifest: {test_path.relative_to(root)}")

    def main():
        root = Path(os.getcwd())
        target = root / "{{ target_dir }}"
        print(f"ðŸ” [ORACLE] Scrying the AST of {target}...")
        
        count = 0
        for path in target.rglob("*.py"):
            if path.name.startswith("test_") or path.name == "__init__.py": continue
            
            try:
                tree = ast.parse(path.read_text(encoding='utf-8'))
                funcs = scry_functions(tree)
                if funcs:
                    forge_shadow_twin(path, funcs, root)
                    count += 1
            except Exception as e:
                print(f"âš ï¸  [ORACLE] Gaze clouded on {path.name}: {e}")

        print(f"âœ… [ORACLE] Inquest complete. {count} Shadow Twins forged.")

    if __name__ == "__main__":
        main()
    """

# --- III. THE KINETIC SYMPHONY (The Execution Path) ---
mirror_oracle.symphony :: """
# == Symphony of the Mirror Oracle ==
# Orchestrates the generation and conduction of the Inquest.

# 1. Forge the Shadow Twins
%% proclaim: "Oracle awakening. Analyzing AST for function signatures..."
%% env: TEST_PERMUTATIONS = "{{ test_permutations }}"
>> python scripts/intelligence/mirror_scrier.py
?? succeeds

# 2. Summon the Inquisitor (Pytest + Hypothesis)
%% proclaim: "Commencing the Great Bombardment ({{ test_permutations }} permutations per unit)..."
>> pytest tests/shadow_twins --verbose
?? succeeds

%% proclaim: "The Mirror Test Oracle has concluded the Inquest. Reality is resilient."
"""

# --- IV. THE UNIVERSAL SUTURE ---
# Binding the Oracle to the project's kinetic limbs
Makefile:
    .PHONY: mirror-inquest mirror-clean
    
    $PYTHON = poetry run python
    $VELM = poetry run velm

    mirror-inquest: ## Forge Shadow Twins and run Property-Based bombardment
        @echo "ðŸ”¥ Initiating Mirror Inquest..."
        $($VELM) run mirror_oracle.symphony

    mirror-clean: ## Return the Shadow Twins to the void
        @echo "ðŸ§¹ Purging Shadow Realm..."
        rm -rf tests/shadow_twins/*.py
        @echo "âœ¨ Shadow Realm purified."

# --- V. THE MAESTRO'S WILL ---
%% post-run
    proclaim: "The Mirror Test Oracle is manifest. Shadow Dimension established."
    
    # [ASCENSION 3]: Dependency Injection
    proclaim: "Summoning the Hypothesis and Pytest-Asyncio artisans..."
    @if {{ use_poetry }}
        >> poetry add hypothesis pytest-asyncio --group dev
    @else
        >> pip install hypothesis pytest-asyncio
    @endif
    
    # 1. Initial Inception
    proclaim: "Conducting initial Gnostic Scrying..."
    >> make mirror-inquest
    
    proclaim: "[bold green]âœ… Shadow Twins Materialized.[/bold green]"
    proclaim: "To re-conduct the Inquest, speak: [bold cyan]make mirror-inquest[/bold cyan]"
    proclaim: "View generated tests in: [bold]tests/shadow_twins/[/bold]"

%% on-heresy
    proclaim: "[bold red]Oracle Inception Fractured.[/bold red]"
    proclaim: "Check if the '{{ target_dir }}' sanctum exists and contains Python scriptures."