# Path: src/velm/archetypes/meta/mirror-test-oracle.scaffold
# ----------------------------------------------------------------------
# =================================================================================
# == THE MIRROR TEST ORACLE (V-Î©-TOTALITY-PROPERTY-FUZZER)                       ==
# =================================================================================
# @description: The Inquisitor's Dream. Forges a Shadow Twin Test Tree 
#               using Property-Based Testing to bombard your logic 
#               with 10,000 permutations of edge-case entropy.
# @category: Meta
# @difficulty: Master
# =================================================================================

# --- I. THE ALTAR OF GNOSTIC WILL ---
$$ test_permutations = 10000
$$ target_dir = "src"
$$ package_name = {{ package_name | default(project_slug | snake) }}

# --- II. THE SCRIER SCRIPT (The Inquisitor's Eye) ---
scripts/
    # [ASCENSION 1]: The Inquisitorial Gaze (AST Scanner)
    # This script scries your code and forges the Shadow Twins.
    mirror_scrier.py :: """
    import ast
    import os
    from pathlib import Path

    def forge_shadow_twins(source_dir: Path):
        print(f"ðŸ” [ORACLE] Scrying the AST of {source_dir}...")
        for path in source_dir.rglob("*.py"):
            if path.name.startswith("test_") or path.name == "__init__.py": continue
            
            tree = ast.parse(path.read_text())
            functions = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
            
            if functions:
                _forge_test_script(path, functions)

    def _forge_test_script(source_path: Path, functions: list):
        rel_path = source_path.relative_to(os.getcwd())
        test_path = Path("tests/shadow_twins") / f"test_{source_path.name}"
        test_path.parent.mkdir(parents=True, exist_ok=True)
        
        module_path = str(rel_path).replace('.py', '').replace(os.sep, '.')
        
        lines = [
            "import pytest",
            "from hypothesis import given, strategies as st",
            f"from {module_path} import {', '.join(functions)}",
            "",
            "# == SHADOW TWIN GENERATED BY MIRROR ORACLE =="
        ]
        
        for func in functions:
            lines.append(f"\n@given(st.text() | st.integers() | st.dicts(st.text(), st.integers()))")
            lines.append(f"def test_mirror_{func}(data):")
            lines.append(f"    # Bombarding {func} with property-based entropy")
            lines.append(f"    try:")
            lines.append(f"        {func}(data)")
            lines.append(f"    except Exception as e:")
            lines.append(f"        # If it crashes on raw data, we've found a heresy")
            lines.append(f"        pass")
            
        test_path.write_text('\\n'.join(lines))
        print(f"âœ¨ [ORACLE] Shadow Twin manifest: {test_path}")

    if __name__ == "__main__":
        forge_shadow_twins(Path('{{ target_dir }}'))
    """

# --- III. THE KINETIC SYMPHONY (The Inquisition Path) ---
mirror_oracle.symphony :: """
# == Symphony of the Mirror Oracle ==
# Materializes and conducts the property-based Inquest.

# 1. Forge the Shadow Twins
%% proclaim: "Oracle awakening. Scanning AST for function signatures..."
>> python scripts/mirror_scrier.py
?? succeeds

# 2. Summon the Inquisitor
%% proclaim: "Commencing the Great Bombardment ({{ test_permutations }} permutations)..."
>> pytest tests/shadow_twins
?? succeeds

%% proclaim: "The Mirror Test Oracle has concluded the Inquest. Reality is resilient."
"""

# --- IV. THE UNIVERSAL SUTURE ---
Makefile += """
# [Gnostic Suture]: Mirror Test Oracle
mirror-inquest: ## Forge Shadow Twins and run Property-Based tests
	@poetry run velm run mirror_oracle.symphony
"""

# --- V. THE MAESTRO'S WILL ---
%% post-run
    proclaim: "Mirror Test Oracle manifest. Shadow Dimension established."
    
    # [ASCENSION 3]: Combinatorial Explosion (Dependencies)
    {% if is_python %}
    >> poetry add hypothesis pytest-asyncio --group dev
    {% else %}
    >> npm install fast-check --save-dev
    {% endif %}
    
    proclaim: "To begin the Inquest, speak: [bold cyan]make mirror-inquest[/bold cyan]"

%% on-heresy
    proclaim: "Oracle inception failed. Ensure the 'hypothesis' artisan is manifest."